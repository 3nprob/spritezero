#!/usr/bin/env node

var fs = require('fs');
var glob = require('glob');
var path = require('path');
var spritezero = require('../index.js');
var argv = require('minimist')(process.argv.slice(2), {
    boolean: ['verbose', 'help']
});

if (argv.help) {
    console.log('usage: spritezero ./path/to/svgdirectory');
    console.log('option: --json ./path/to/output.json');
    console.log('option: --png ./path/to/output.png');
    console.log('option: --scale 2');
    return;
}

if (!argv._[0]) {
    console.error('Missing path to svg directory');
    return;
}

var scale = argv.scale || 1;
var pngPath = argv.png ? path.resolve(argv.png) : path.resolve('sprite@' + scale + '.png');
var jsonPath = argv.json ? path.resolve(argv.json) : path.resolve('sprite@' + scale + '.json');
var files = glob.sync(path.resolve(argv._[0] + '/*.svg'))
    .map(function(im) {
        return {
            svg: fs.readFileSync(im),
            id: path.basename(im).replace('.svg', '')
        };
    }).sort(function(a, b) {
        return b.id < a.id;
    });

spritezero.generateLayout(files, scale, true, function(err, formatted) {
    if (err) throw err;

    console.log('Writing json to', jsonPath);
    fs.writeFileSync(jsonPath, JSON.stringify(formatted, null, 2));

    spritezero.generateLayout(files, scale, false, function(err, layout) {
        if (err) throw err;

        spritezero.generateImage(layout, function(err, res) {
            if (err) throw err;

            console.log('Writing png to', pngPath);
            fs.writeFileSync(pngPath, res);
        });
    });
});
